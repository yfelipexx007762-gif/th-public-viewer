<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- T칤tulo da p치gina atualizado -->
    <title>Anexos do Servi칞o</title>
    
    <!-- Link para a biblioteca da galeria (inalterado) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox/dist/css/glightbox.min.css" />
    
    <!-- Link para o seu CSS customizado (inalterado) -->
    <link rel="stylesheet" href="visualizador-anexos.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <!-- Caminho para a sua logo (inalterado) -->
            <img src="/img/LOGO TH PRETO.png" alt="Logo TH Transportes">
            <!-- ID e texto atualizados -->
            <h1 id="service-code">Carregando...</h1>
            <p>Visualizador de Anexos</p>
        </header>

        <main>
            <div id="loading">Carregando anexos, por favor aguarde...</div>
            <div id="not-found" style="display: none;">Nenhum anexo encontrado ou o link 칠 inv치lido.</div>
            <div id="gallery">
                <!-- Os cards de arquivos ser칚o inseridos aqui -->
            </div>
        </main>
    </div>

    <!-- Script da biblioteca da galeria (inalterado) -->
    <script src="https://cdn.jsdelivr.net/gh/mcstudios/glightbox/dist/js/glightbox.min.js"></script>

    <!-- SCRIPT CORRIGIDO E ATUALIZADO -->
    <script>
    document.addEventListener('DOMContentLoaded', async () => {
        // Seletores de elementos do DOM
        const gallery = document.getElementById('gallery');
        const loading = document.getElementById('loading');
        const notFound = document.getElementById('not-found');
        // Seletor do t칤tulo atualizado
        const serviceCodeEl = document.getElementById('service-code');

        // URL do seu Cloudflare Worker. Verifique se est치 correta.
        const workerUrl = 'https://erp-link-resolver.felipe-contatoo2006.workers.dev'; 

        try {
            // 1. Pega a chave curta do link da URL (ex: aB3xZ7 de #aB3xZ7)
            const key = window.location.hash.substring(1);
            if (!key) {
                throw new Error('Link inv치lido ou expirado. Nenhum c칩digo de compartilhamento foi encontrado.');
            }

            // 2. Chama o Worker para buscar os dados no KV
            const response = await fetch(`${workerUrl}?id=${key}`);
            
            // Tratamento de erro aprimorado
            if (!response.ok) {
                // Tenta ler uma mensagem de erro do Worker, sen칚o usa uma padr칚o
                const errorData = await response.json().catch(() => ({ error: `O servidor respondeu com um erro (${response.status}).` }));
                throw new Error(errorData.error || `Falha ao buscar os dados do link. Status: ${response.status}`);
            }
            
            const data = await response.json();

            // Valida칞칚o dos dados recebidos do Worker
            if (!data || !data.projectCode) {
                throw new Error('Os dados recebidos do link compartilhado s칚o inv치lidos.');
            }

            // 3. Renderiza o t칤tulo e a galeria com os dados recebidos
            // ATUALIZADO para "Servi칞o"
            serviceCodeEl.textContent = `Servi칞o ${data.projectCode}`;

            if (!data.files || data.files.length === 0) {
                throw new Error('N칚o h치 arquivos para exibir neste link.');
            }

            // Esconde a mensagem de "carregando"
            loading.style.display = 'none';

            // Loop para criar os cards de cada anexo (l칩gica inalterada)
            data.files.forEach(file => {
                const fileUrl = `${data.publicR2Url}/${file.url}`;
                const isImage = /\.(jpg|jpeg|png|gif|webp)$/i.test(file.name);
                const card = document.createElement('a');
                card.href = fileUrl;
                card.className = 'file-card glightbox';
                card.setAttribute('data-gallery', 'project-gallery');
                card.setAttribute('data-title', file.name);

                if (!isImage) {
                    card.classList.remove('glightbox');
                    card.target = '_blank';
                }

                card.innerHTML = `
                    <div class="thumbnail">
                        ${isImage ? `<img src="${fileUrl}" alt="${file.name}">` : `<div class="icon">游늯</div>`}
                    </div>
                    <div class="file-info">
                        <strong>${file.name}</strong>
                        <span class="badge" data-category="${file.category}">${file.category.replace('-', ' ')}</span>
                    </div>
                `;
                gallery.appendChild(card);
            });

            // Inicializa a galeria lightbox ap칩s adicionar os elementos
            const lightbox = GLightbox({ selector: '.glightbox' });

        } catch (error) {
            // Bloco de erro aprimorado para exibir mensagens mais claras
            console.error("Erro ao carregar anexos p칰blicos:", error);
            loading.style.display = 'none';
            serviceCodeEl.textContent = 'Erro ao Carregar'; // T칤tulo de erro
            notFound.textContent = error.message;
            notFound.style.display = 'block';
        }
    });
    </script>
</body>
</html>
